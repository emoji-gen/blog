Title: Google 開発の 2D グラフィックライブラリ Skia の紹介とはじめかた
Date: 2019-01-01 00:00
Modified: 2019-01-01 00:00
Slug: skia

みなさん、こんにちは。今回は絵文字ジェネレーターの肝となる、絵文字の画像生成についての記事です。

<a href="https://emoji-gen.ninja" target="_blank" rel="bookmark">絵文字ジェネレーター</a> のサーバーサイドは Python で書かれています。そして、絵文字画像の生成部分は、独自のライブラリを C++ で開発し、それを <a href="https://cython.org/">Cython</a> 経由で呼び出しています。

画像生成部分では、<a href="https://skia.org/" target="_blank" rel="noopener">Skia</a> という 2D グラフィックライブラリを中で呼び出しています。Skia は Google が中心となって開発している C++ で書かれたライブラリで、Google Chrome や Android などの大きなプロダクトでも採用されています。

この記事では、2D グラフィックライブラリである Skia の概要と、簡単な使い方を具体的なコマンド・ソースコードを交えて紹介します。次に、絵文字ジェネレーターでの Skia の利用例を解説して行こうと思います。

<!-- PELICAN_END_SUMMARY -->

## Skia とは?
Skia とは、Google が OSS として開発している 2D グラフィックライブラリです。C++11 で書かれており、スマートポインタを活用した使いやすいモダンなインターフェイスが特徴です。Skia は Google Chrome や Android など、Google のプロダクトで主に利用されています。

サポートしている動作環境も幅広く、x86_64 アーキテクチャが主流な Windows や macOS、Linux はもちろん、Android や iOS もターゲットです。Skia は多機能なライブラリであり、レポジトリも巨大です。

## Skia の簡単な使い方
### はじめに
Skia は高機能で綺麗な C++ インターフェイスを持ったライブラリなのですが、ドキュメントがほとんど用意されていません。日本語のドキュメントに至っては、ほぼ皆無です。そのため、Skia を使って本格的に開発する場合は、ある程度の覚悟が必要です。

オススメは、Skia 本体のソースコードと、Skia を使った何らかのプロジェクトを読むことです。私は Android と <a href="https://github.com/mono/SkiaSharp" target="_blank" rel="noopener">SkiaSharp</a> のソースコードを参考にしました。

この記事では、Skia を使う際にはじめに躓くであろうライブラリのビルドと、簡単なサンプルを紹介していきます。この記事をきっかけに、Skia を使う方が増えていただけると嬉しいです。

### ライブラリのビルド
Skia は C++ で書かれた巨大なライブラリであり、予めビルドが必要です。環境にもよりますが、キャッシュがない状況では 15〜30 分はかかると考えておいてください。

<small>**※ この記事では macOS (10.14 Mojave) 上で動作確認しています。Skia 自体は他の環境にも対応していますが、実行する環境に応じてコマンドを適宜書き換える必要があります。**</small>

まず、必要なソースコードを Git を用いて取得します。

```sh
$ mkdir -p ~/tmp/
$ cd ~/tmp/
$ git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
$ git clone https://skia.googlesource.com/skia.git
```

`depot_tools` には、Skia をビルドする際に必要な各種ツールが含まれています。これらのツールが Python 2.7 へ依存しているため、ビルドする環境には Python 2.7 が必要です。

次に、`depot_tools` へパスを通した後、ビルドするコマンドを実行します。今回はビルドの成果物として、静的ライブラリ `libskia.a` を生成することを目標とします。

```sh
$ python --version
Python 2.7.15

$ cd ~/tmp/skia
$ python tools/git-sync-deps
$ PATH="$HOME/tmp/depot_tools:$PATH" gn gen out/Static --args="is_debug=false target_cpu=x64 is_official_build=true skia_use_system_libjpeg_turbo=false skia_use_system_libpng=false skia_use_system_libwebp=false skia_use_system_icu=false"

```

`git-sync-deps` コマンドは、Skia が依存しているライブラリを Git で取得してくるラッパースクリプトです。

`gn` コマンドは Generate Ninja の略で、ビルドツール <a href="https://ninja-build.org/" target="_blank" rel="noopener">ninja</a> でビルドする為に必要なファイルを生成するためのメタビルドシステムです。`gn` は `make` に対する `cmake` の位置づけになります。`gn` へ渡している引数では、システムのライブラリではなく、サブモジュールのライブラリをコンパイルしリンクするように指示をしています。

最後に `ninja` コマンドを使いビルドを実行します。ここで結構時間がかかります。`ninja` 自体は `depot_tools` に含まれているため、別途インストールする必要はありません。

### サンプルの作成


## 絵文字ジェネレーターでの採用事例

